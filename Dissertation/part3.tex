\chapter{Численный анализ времени игры}\label{ch:ch3}

Рассмотренные методы в предыдущей главе для численной симуляции процесса,
моделирования эволюции вероятности и расчета фундаментальной матрицы 
были реализованы на языке Python 3.8. 
Применяя данные методы были вычислены статистические свойства и распределения, 
рассмотренные в разделе \cref{}, для сравнения с модельной и экспериментально полученной статистикой. 
Расчет трех подходов (численное моделирование, моделирование вероятностной эволюции, расчет фундаментальной матрицы) 
и их статистические свойства были выполнены на рабочей станции (Core i5-8600 3,1 ГГц, 32 ГБ ОЗУ). 
Исходный код программы обсчета доступен по адресу https://github.com/SermanVS/RWAnalyzer.

Результаты рассматривают игру двух оппонентов на квадратной решетке для различных случаев:
BvB -- случайное блуждание на квадратной решетке, PvP -- игра между двумя игроками, PvE игра за центр против компьютера, PvE игра за границу против компьютера. 
Сравнение с экспериментально полученными траекториями осуществлялось на поле 17 \times 17 в играх с 
реальными игроками. Выбор размера поля был определен на основе наблюдений за игроками при игре на различных размерах поля.
Анализ показал, что уменьшение размера поля приводит к быстрому завершению игры, что не дает игрокам находить качественные сложные
стратегии. При увеличении размера поля игры длятся слишком долго, что вызывает усталость, снижение концентрации.
Это в свою очередь ведет к уменьшению заинтересованности игрока, цель которого оставаться внутри поля, в длительном матче,
а также к фрустрации игрока, цель которого достичь границы как можно скорее из-за многочисленных неудач.
Вариант игры на поле 17 \times 17 демонстрирует среднее время игры 10-15 минут, что позволяет игрокам оставаться вовлеченными
в процесс и придерживаться своих целей. Однако, длительные игры более часа также возникают в процессе проведения эксперимента.
Дополнительный анализ таких игр также был проведен в рамках данной работы.

Суммарно, играя в Random Walk Game, участники эксперимента провели около 250 часов для создания исследуемого набора траекторий.
В результате было получено 1562 траектории позиции фишки на поле и соответствующих выборов игроков для трех режимов игры. 
Дополнительно была собрана информация о времени совершения хода каждым из игроков. 
Далее проводится анализ статистических свойств полученных траекторий и стратегий игроков, 
а также их сравнение с результатами численного анализа, моделирования и аналитических расчетов.

\section{Среднее время игры}\label{sec:ch3/sec1}

Основной целью для игроков является увеличение или уменьшение количества ходов, за которое будет достигнута граница поля.
Однако, основная особенность рассматриваемой игры состоит в наличии случайной компоненты, не зависящей напрямую от игроков и лежащей в основе механики их взаимодействия.
Для исключения влияния случайной компоненты на результирующий функционал был предложен подход к оценке среднего количества ходов,
за которое фишка достигнет границу поля (среднее время игры).
Применение такого подхода позволяет находить оптимальные стратегии, дающие максимум или минимум среднего времени игры в зависимости от цели игрока.

\subsection{Вырожденный случай BvB неуправляемого случайного блуждания}\label{subsec:ch3/sec1/sub1}

В случае BvB игроки совершают равновероятный выбор на каждом ходу одного из двух выборов, то есть среднее время игры зависит только от размера поля.
Применяя метод расчета фундаментальной матрицы для поглощающей Марковской цепи для разных размеров поля были получены значения среднего времени игры для случая BvB.
Используя аппроксимацию квадратичной зависимостью на основе метода наименьших квадратов (НМК) зависимости среднего времени для размеров полей в диапазоне от 3 до 1001
были получены численные коэффициенты параболы: ${\bf t_n^{BvB}} = 0.294685413 n^2 - 0.232$. Средняя абсолютная ошибка аппроксимации составила $10^{-3}$. 
Хотя простого способа представления в замкнутой форме данной зависимости еще не было найдено, в работе \cite{} была предложена форма из нескольких сумм, позволяющая оценить
среднее время игры для случая BvB, как простого случая случайного блуждания на ограниченном квадрате.

\subsection{Задача глобальной оптимизации для случая PvE}\label{subsec:ch3/sec1/sub1}

Рассмотрение случаев PvE приводит к необходимости поиска оптимальных стратегий. В связи с этим возникает постановка задачи 
математического программирования по глобальной оптимизации среднего времени игры в пространстве стратегий. 
Как было рассмотрено в разделе \cref{} в соответствии с формулой \cref{} функция среднего времени игры
зависит от двух векторов с вещественными элементами из диапазона $[0, 1]$, характеризующих стратегии каждого из игроков.
В случае PvE стратегия одного из игроков фиксирована и может быть исключена из аргументов задачи оптимизации.
Тогда возникают две независимые задачи оптимизации для случаев игры за центр и за границу:
\begin{equation}
    \begin{aligned}
    {\bf t_n^{PvEA}} = \max_{f^A \in {\bf F}} {\bf t_n}, \hspace{1em} f_{ij}^B=1/2,
    \label{eq:centeropt}
    \end{aligned}
\end{equation}
\begin{equation}
    \begin{aligned}
    {\bf t_n^{PvEB}} = \min_{f^B \in {\bf F}} {\bf t_n}, \hspace{1em}  f_{ij}^A=1/2,
    \label{eq:borderopt}
    \end{aligned}
\end{equation}
где $F$ - пространство векторов с элементами в диапазоне $[0, 1]$, которые соответствуют выбранным относительным частотам $f_{ij}^p$
в смешанных стратегии игрока $p \in [A, B]$. Расчет ${\bf t_n}$ осуществляется с применением рассмотренного подхода поглощающих Марковских цепей
в разделе \cref{} с использованием формул \cref{}, ... .

Количество переменных в задаче оптимизации растет квадратично с ростом размера поля, что существенно усложняет анализ для выбранных размеров 17 \times 17.
Однако для случаев с небольшим числом оптимизируемых переменных задача может быть решена напрямую поиском глобального оптимума.
Применяя алгоритм \texttt{Minimize} математического пакета Wolfram Mathematica для решетки размеров 5 и 7 удалось получить значения
оптимального времени игры для случаев игры против случайного равновероятного выбора компьютером (PvE), а также набор найденных стратегий.
Случай 3 \times 3 не представляет прямого интереса, так как среднее время поглощения равно 1 независимо от выбора стратегий игроков, 
так как поглощение фишки происходит на первом ходу. Случай 5 \times 5 уже не является вырожденным и выборы игроков влияют на результат среднего времени игры.
Всего при решении данного случая возникает задача оптимизации с 9 параметрами, которая может быть решена с применением \texttt{Minimize}.

Количество параметров для решения задачи большего размера при использовании данного подхода слишком велико, что не позволяет без упрощения найти оптимальную стратегию.
Для уменьшения размерности воспользуемся симметриями в игре стратегий игроков относительно главной и побочной диагоналей. 
Две симметрии позволяют свернуть игру уже на одном из 4 треугольников между главной и побочной диагоналями. 
Для определенности выберем верхний треугольник. Тогда верхняя граница, как и ранее, соответствует граничным поглощающим состояниям,
а две новые стороны треугольника соответствуют отражающим границам, то есть из состояний на диагонали возможно перейти только в 2 соседних состояния внутри треугольника.
Учет данных симметрий позволяет приблизительно в 4 раза уменьшить количество состояний и соответственно количество различных элементов в векторе стратегий,
что позволило решить задачу для случая 7 \times 7. 

\subsection{Гипотеза об оптимальных стратегиях для случая PvE}\label{subsec:ch3/sec1/sub1}

Анализируя стратегии и значения среднего времени игры, найденные с применением глобальной оптимизации, для малых размерностей,
а также учитывая свойства игры, для достижения оптимальных значений были предложены 2 стратегии.
Случай PvE состоит из двух вариантов игры: с целью удержать фишку как можно дольше внутри поля (максимизировать среднее время игры)
и с целью как можно скорее достичь границы (минимизировать среднее время игры). 
Значения оптимального среднего времени игры для обоих случаев представляют квадраты нечетных чисел для малых размеров поля.
В случае PvE при игре за центр формула представляется в виде: ${\bf t_n^{PvE A}} = (n-2)^2$ и в случае
игры за границу в виде: ${\bf t_n^{PvE B}} = (n-1)^2/4$.

В предположении сохранения такой же закономерности для больших размеров поля, рассмотрим стратегии, достигающие
средних времен игры ${\bf t_n^{PvE B}}$ и ${\bf t_n^{PvE A}}$. Принцип построения стратегии в обоих случаях 
состоит в выборе некоторой одномерной структуры внутри поля, на которой игрок может поддерживать блуждание без выхода за границу этой структуры.
Такая структура будет представлять собой одномерную марковскую цепь, по которой игрок может осуществлять некоторое блуждание.
При этом большее количество узлов цепи будет соответствовать большим средним временам. Таким образом в случае игры за центр
необходимо выбрать наиболее длинную такую структуру, а в случае игры за границу наиболее короткую.

Самая длинная одномерная цепь, внутри которой игрок за центр может сохранять свою фишку независимо от выборов второго игрока, 
представляет собой "лестницу" состояний на главной диагонали. С характеристикой наиболее длинной цепи также существует побочная диагональ, однако
правила игры не позволяют поддерживать случайное блуждание на ней независимо от ходов второго игрока. 
Для поддержания фишки на "лестнице" главной диагонали игрок чередует свой выбор кнопок на каждом ходу.
Выбор такой структуры позволяет получить одномерную марковскую 
цепь длины $2n-3$, случайное блуждание вдоль которой осуществляется равновероятно в обоих направлениях, так как $f_{ij}^B=1/2$.
Такая Марковская цепь соответствует случаю игры о разорении игрока с одной валютой. Применяя формулу для среднего времени случайного блуждания на отрезке,
рассмотренную в разделе \cref{} формуле \cref{}, получим среднее время ${\bf t_n^{PvE A}} = ((2n-3-1)/2)^2 = (n-2)^2$ соответствующее обнаруженной закономерности.

Аналогично, применяя принцип поиска структуры одномерной цепи, выберем самую короткую цепь для случая игры за границу.
Такой цепью будет являться горизонтальный или вертикальный отрезок, проходящий через центральную стартовую позицию.
Независимо от выборов первого игрока, второй игрок сможет выбирая одну и ту же кнопку оставаться на данном отрезке.
Полученная цепь состоит из $n$ состояний, что дает среднее время поглощения ${\bf t_n^{PvE B}} = (n-1)^2/4$.
Игрок не обязательно должен выбрать только один из отрезков, а может использовать их комбинацию, переходя в центральном узле между ними,
ввиду симметрий рассмотренных в предыдущем разделе. 

Рассмотренные стратегии не являются единственными достигающими найденные значения среднего времени игры. 
Одна из стратегий для случая игры за центр, использующая не только одномерный набор состояний, а все игровое поле целиком, 
может быть сформулирована следующим образом: в состояниях соседних с граничными выбор стратегии состоит в движении от границы или вдоль нее, 
а во всех остальных состояниях выбор осуществляется произвольным образом. Применяя символьные вычисления Wolfram Mathematica
в методе расчета среднего времени игры с использованием фундаментальной матрицы было продемонстрировано для размеров поля
$5, 7, 9, 11$, что все переменные $f_{ij}^A$, соответствующие состояниям не инцидентным границе, после упрощения выражения имеют нулевые коэффициенты.
Времена, получаемые при данной стратегии, также совпадают с найденной закономерностью ${\bf t_n^{PvE A}}$.

Все 3 найденных зависимости среднего времени игры для трех случаев представляют собой квадратичную функцию с различными коэффициентами.
Старший коэффициент при $n^2$ для случая PvE за центр -- $1$, для случая PvE за границу -- $0.25$, для случайного блуждания BvB -- $0.29$.
Таким образом, предполагаемая оптимальная стратегия в случае PvE игры за центр показывает время в $3.4$ раза большее, чем случайный равновероятный выбор игрока в случае BvB.
В случае же игры PvE за границу время оказывается меньше, чем при случайном равновероятном выборе в случае BvB, приблизительно на $15\%$.


\subsection{Сравнение с экспериментальными результатами}\label{subsec:ch3/sec1/sub1}

Следующим шагом в анализе игровой динамики является рассмотрение сравнения результатов моделирования с результатами 
собранных игр в полевом эксперименте. Сбор траекторий в эксперименте осуществлялся с применением разработанной игры Random Walk Game
и участием нескольких десятков людей. Подробное описание эксперимента приведено в разделе \cref{}. Суммарно в режиме 
PvE было собрано $1062$ игры: $528$ -- игры за центр, $534$ -- игры за границу. 

Участники, цель которых была удерживать фишку как можно
дольше внутри поля в среднем показали $145.45$ ходов за игру. Сравнивая этот результат с предположительно оптимальной стратегией 
среднее время которой равно ${\bf t_{17}^{PvE A}} = (17-2)^2 = 225$, получаем отставание на $54\%$ реальных игр от результатов моделирования.
Хотя игроки показали не оптимальное время игры, выбранная ими стратегия позволяет улучшить в $2$ раза результат относительно $75.2$ хода
в случае равновероятного выбора (BvB). Эксперимент показал, что рассматриваемая группа игроков способна распознать свойства игры 
и значительно улучшить среднее время игры несмотря на отсутствие априорного знания об оптимальной стратегии. 
В качестве подтверждения качества стратегии, найденной игроками, были получены относительные частоты для каждой позиции на поле
и проведено моделирование столкновения стратегий случайного выбора против стратегии игроков. В результате моделирования было получено 
характерное среднее время игры $145.85$ согласующееся со средним временем экспериментальных траекторий.

Результаты игр участников в случае PvEс целью скорейшего достижения границы продемонстрировали среднее количество ходов равное $71.12$.
В сравнении с предполагаемой оптимальной стратегией, среднее время которой равно ${\bf t_n^{PvE B}} = (17-1)^2/4 = 64$, игроки 
отстают на 7 ходов. Несмотря на такое отставание, среднее время игры у участников меньше на 4 хода, чем в случае равновероятного выбора. 
Аналогично предыдущему случаю игры за центр, игроки показали улучшение относительно случайного блуждания BvB и достаточно большой разрыв со средним временем игры
для предполагаемой оптимальной стратегии. Моделирование игровой динамики за счет столкновения стратегий равновероятного случайного выбора и 
частот выборов, полученных из эксперимента, продемонстрировало отличие среднего времени игры, равного $73.79$, относительно среднего числа ходов в траекториях игроков.
Предположительно, данное отличие вызвано неточными частотами в редко посещаемых состояниях. 



\section{Четность времени игры}\label{sec:ch3/sec2}

\section{Распределение времен игры}\label{sec:ch3/sec3}

\section{Пространственное распределение}\label{sec:ch3/sec4}

\section{Анализ стратегий}\label{sec:ch3/sec5}


